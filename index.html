<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora ML 2025 (Educativa)</title>
    <style>
        :root {
            --primary: #ffe600;
            --secondary: #2d3277;
            --text: #333;
            --light-gray: #f5f5f5;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --white: #ffffff;
            --tooltip-bg: #2d3277;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: var(--light-gray);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: var(--secondary); margin: 0; }
        
        /* Layout */
        .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 25px; }
        .card { background: var(--white); padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        /* Form Elements */
        h2 { margin-top: 0; font-size: 1.4em; color: var(--secondary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block;}
        .form-group { margin-bottom: 20px; }
        
        /* Labels with Tooltip Alignment */
        .form-group label { 
            display: flex; align-items: center; 
            font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: var(--secondary); 
        }
        
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .input-group { display: flex; gap: 0; }
        .input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; flex: 2; }
        .input-group select { border-top-left-radius: 0; border-bottom-left-radius: 0; flex: 1; background: #f9f9f9; border-left: 0; min-width: 100px;}

        /* --- TOOLTIP SYSTEM (CSS Only) --- */
        .tooltip-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 18px; height: 18px; background: #e0e0e0; color: #555;
            border-radius: 50%; font-size: 12px; margin-left: 8px; cursor: help;
            font-weight: bold; transition: 0.2s;
        }
        .tooltip-icon:hover { background: var(--secondary); color: #fff; }

        .tooltip-wrapper { position: relative; }
        
        .tooltip-content {
            visibility: hidden; opacity: 0;
            width: 250px; background-color: var(--tooltip-bg); color: #fff;
            text-align: left; border-radius: 6px; padding: 10px;
            position: absolute; z-index: 10; bottom: 135%; left: 50%; margin-left: -125px;
            font-size: 0.85em; font-weight: normal; line-height: 1.4;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); pointer-events: none;
            transition: opacity 0.3s, transform 0.3s; transform: translateY(10px);
        }
        
        /* Arrow for tooltip */
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: var(--tooltip-bg) transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip-content {
            visibility: visible; opacity: 1; transform: translateY(0);
        }

        /* Reputation Selector */
        .reputation-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .rep-option { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; text-align: center; cursor: pointer; font-weight: bold; opacity: 0.6; font-size: 0.9em; }
        .rep-option.active { opacity: 1; border: 2px solid #333; transform: scale(1.02); }
        .rep-green { background-color: #d4edda; color: #155724; }
        .rep-yellow { background-color: #fff3cd; color: #856404; }
        .rep-orange { background-color: #ffe8cc; color: #fd7e14; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; padding: 10px 20px; font-size: 1.1em; font-weight: bold; color: #777; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .tab-btn.active { background: var(--secondary); color: var(--white); }
        .tab-btn:hover:not(.active) { background: #e9ecef; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Results */
        .btn { background: var(--secondary); color: #fff; border: none; padding: 15px; width: 100%; border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #1a1e4d; }
        
        .result-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; text-align: center; }
        .final-result { font-size: 2.5em; font-weight: 800; color: var(--secondary); margin: 10px 0; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 20px; }
        td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        .text-right { text-align: right; }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); font-weight: bold; }

        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Calculadora ML 2025</h1>
        <p>Pre√ßo Ideal (Reverso) e Simula√ß√£o de Lucro (Direto)</p>
    </div>

    <div class="grid">
        <div class="card">
            <h2>1. Estrutura do Vendedor</h2>
            
            <div class="form-group">
                <label>
                    Sua Reputa√ß√£o
                    <div class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            <strong>Impacto no Frete:</strong><br>
                            üü¢ <strong>Verde/L√≠der:</strong> ~50% de desconto no frete.<br>
                            üü° <strong>Amarela:</strong> ~40% de desconto.<br>
                            üî¥ <strong>Laranja:</strong> Sem desconto (paga 100% da tabela).
                        </div>
                    </div>
                </label>
                <div class="reputation-selector">
                    <div class="rep-option rep-green active" onclick="setReputation('green')" id="btn-green">Verde/L√≠der</div>
                    <div class="rep-option rep-yellow" onclick="setReputation('yellow')" id="btn-yellow">Amarela</div>
                    <div class="rep-option rep-orange" onclick="setReputation('orange')" id="btn-orange">Laranja/Verm</div>
                </div>
                <input type="hidden" id="reputation" value="green">
            </div>

            <div class="form-group">
                <label>
                    Peso do Produto (Tabela 2025)
                    <div class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            O ML calcula o frete pelo <strong>maior valor</strong> entre o peso real (balan√ßa) e o peso c√∫bico (medidas). Selecione a faixa correta para evitar preju√≠zo no c√°lculo autom√°tico.
                        </div>
                    </div>
                </label>
                <select id="productWeight">
                    <option value="0.3">At√© 300g</option>
                    <option value="0.5">300g a 500g</option>
                    <option value="1.0">500g a 1kg</option>
                    <option value="2.0">1kg a 2kg</option>
                    <option value="3.0">2kg a 3kg</option>
                    <option value="4.0">3kg a 4kg</option>
                    <option value="5.0">4kg a 5kg</option>
                    <option value="9.0">5kg a 9kg</option>
                    <option value="13.0">9kg a 13kg</option>
                    <option value="17.0">13kg a 17kg</option>
                </select>
            </div>

            <h2>2. Custos do Produto</h2>
            
            <div class="form-group">
                <label>
                    Custo do Produto (CMV) *
                    <div class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            Quanto o produto custa para voc√™. Some o valor de compra ou fabrica√ß√£o.
                        </div>
                    </div>
                </label>
                <input type="number" id="productCost" placeholder="R$ 0,00" step="0.01">
            </div>

            <div class="form-group">
                <label>
                    Despesas Operacionais
                    <div class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            Custos de embalagem (caixa, fita, etiqueta).<br>
                            <strong>Fixo (R$):</strong> Some seu custo total (ex: estoque, folha de pagamento, entre outros).<br>
                            <strong>Porcentagem (%):</strong> Desconta do pre√ßo final (ex: marketing, reserva de erro).
                        </div>
                    </div>
                </label>
                <div class="input-group">
                    <input type="number" id="opExpenses" placeholder="3,00" step="0.01">
                    <select id="opExpensesType">
                        <option value="fixed">R$ (Fixo)</option>
                        <option value="pct">% (Venda)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>
                    Tipo de An√∫ncio
                    <div class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            <strong>Cl√°ssico (~11.5%):</strong> Menor exposi√ß√£o.<br>
                            <strong>Premium (~16.5%):</strong> Maior exposi√ß√£o e oferece parcelamento sem juros ao comprador.
                        </div>
                    </div>
                </label>
                <select id="listingType">
                    <option value="classic">Cl√°ssico (11.5%)</option>
                    <option value="premium">Premium (16.5%)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    Impostos (%)
                    <div class="tooltip-wrapper">
                        <span class="tooltip-icon">?</span>
                        <div class="tooltip-content">
                            Al√≠quota da sua nota fiscal (Simples Nacional).<br>
                            Se for <strong>MEI</strong>, coloque 0 (o custo √© fixo mensal).
                        </div>
                    </div>
                </label>
                <input type="number" id="taxRate" placeholder="Ex: 4.0" step="0.1">
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('target-margin')" id="tab-btn-margin">Definir Pre√ßo</button>
                <button class="tab-btn" onclick="switchTab('target-price')" id="tab-btn-price">Simular Lucro</button>
            </div>

            <div id="tab-target-margin" class="tab-content active">
                <div class="form-group" style="background: #e8f4fd; padding: 15px; border-radius: 6px;">
                    <label>
                        Margem L√≠quida Desejada (%)
                        <div class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                Quanto voc√™ quer que sobre no bolso (LUCRO LIMPO) ap√≥s pagar produto, taxas ML, frete e impostos.
                            </div>
                        </div>
                    </label>
                    <input type="number" id="desiredMargin" placeholder="Ex: 15" step="0.1">
                </div>
                <button class="btn" onclick="calculateReverse()">Calcular Pre√ßo Ideal</button>
            </div>

            <div id="tab-target-price" class="tab-content">
                <div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                    <label>
                        Pre√ßo de Venda Final (R$)
                        <div class="tooltip-wrapper">
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                Insira o pre√ßo que voc√™ quer praticar para descobrir quanto sobrar√° de lucro.
                            </div>
                        </div>
                    </label>
                    <input type="number" id="desiredPrice" placeholder="Ex: 89,90" step="0.01">
                </div>
                <button class="btn" onclick="calculateProfit()">Simular Lucro</button>
            </div>

        </div>

        <div class="card">
            <h2>3. Resultado</h2>
            
            <div id="emptyState" style="text-align:center; color:#999; padding: 40px;">
                <p>Preencha os dados e clique em calcular.</p>
            </div>

            <div id="resultContainer" style="display:none;">
                <div class="result-box">
                    <span id="resultLabel">Pre√ßo Sugerido</span>
                    <div class="final-result" id="displayMainResult">R$ 0,00</div>
                    <div id="subResultInfo" style="font-size: 1.2em; font-weight:bold; color:#555;"></div>
                </div>

                <table>
                    <tbody>
                        <tr>
                            <td>(+) Venda Bruta</td>
                            <td class="text-right" id="dtPrice">R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>(-) Custos (Produto + Ops)</td>
                            <td class="text-right text-danger" id="dtTotalCost">- R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>(-) Impostos + Comiss√£o</td>
                            <td class="text-right text-danger" id="dtTaxComm">- R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>
                                (-) Frete (Seller)
                                <div class="tooltip-wrapper" style="display:inline-block; margin-left:5px;">
                                    <span class="tooltip-icon" style="width:14px; height:14px; font-size:10px;">?</span>
                                    <div class="tooltip-content">
                                        Calculado dinamicamente com base no pre√ßo e reputa√ß√£o. Abaixo de R$ 79,00 o frete √© por conta do comprador.
                                    </div>
                                </div>
                                <small style="display:block; color:#777;" id="shippingDesc">Isento (< 79)</small>
                            </td>
                            <td class="text-right text-danger" id="dtShipping">- R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>
                                (-) Taxa Fixa ML
                                <div class="tooltip-wrapper" style="display:inline-block; margin-left:5px;">
                                    <span class="tooltip-icon" style="width:14px; height:14px; font-size:10px;">?</span>
                                    <div class="tooltip-content">
                                        Custo fixo por unidade para vendas abaixo de R$ 79,00. Varia entre R$ 6,25 e R$ 6,75.
                                    </div>
                                </div>
                            </td>
                            <td class="text-right text-danger" id="dtFixedFee">- R$ 0,00</td>
                        </tr>
                        <tr style="background-color: #f0f8ff; font-weight: bold;">
                            <td style="color:var(--success);">(=) Lucro L√≠quido</td>
                            <td class="text-right text-success" id="dtProfit">R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>Margem Real</td>
                            <td class="text-right" id="dtMargin">0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATA ---
    // Full Price Table (Tabela Cheia 2025 - Ref 40547)
    const BASE_SHIPPING_TABLE = [
        { max: 0.3, cost: 39.90 }, { max: 0.5, cost: 42.90 }, { max: 1.0, cost: 44.90 },
        { max: 2.0, cost: 46.90 }, { max: 3.0, cost: 49.90 }, { max: 4.0, cost: 53.90 },
        { max: 5.0, cost: 56.90 }, { max: 9.0, cost: 88.90 }, { max: 13.0, cost: 131.90 },
        { max: 17.0, cost: 146.90 }
    ];

    // Discounts by Reputation [Price 79, 100, 120, 150, 200]
    const DISCOUNT_MATRIX = {
        'green':  [0.30, 0.35, 0.40, 0.45, 0.50], 
        'yellow': [0.40, 0.45, 0.50, 0.55, 0.60],
        'orange': [1.00, 1.00, 1.00, 1.00, 1.00]
    };

    const LISTING_RATES = { 'classic': 0.115, 'premium': 0.165 };

    // --- HELPER FUNCTIONS ---

    function getCommonInputs() {
        return {
            cost: parseFloat(document.getElementById('productCost').value) || 0,
            weight: parseFloat(document.getElementById('productWeight').value),
            reputation: document.getElementById('reputation').value,
            taxPct: (parseFloat(document.getElementById('taxRate').value) || 0) / 100,
            commissionPct: LISTING_RATES[document.getElementById('listingType').value],
            opVal: parseFloat(document.getElementById('opExpenses').value) || 0,
            opType: document.getElementById('opExpensesType').value
        };
    }

    // Determine Shipping Cost based on Price, Weight and Reputation
    function getShippingCost(price, weight, reputation) {
        if (price < 79.00) return 0; // Buyer pays

        // Get Base Cost
        const baseRow = BASE_SHIPPING_TABLE.find(r => r.max >= weight) || BASE_SHIPPING_TABLE[BASE_SHIPPING_TABLE.length-1];
        const baseCost = baseRow.cost;

        // Get Discount Index
        let idx = 0;
        if (price >= 200) idx = 4;
        else if (price >= 150) idx = 3;
        else if (price >= 120) idx = 2;
        else if (price >= 100) idx = 1;
        else idx = 0; // 79-99

        const multiplier = DISCOUNT_MATRIX[reputation][idx];
        return baseCost * multiplier;
    }

    // Determine Fixed Fee based on Price
    function getFixedFee(price) {
        if (price >= 79.00) return 0;
        if (price >= 50.00) return 6.75;
        if (price >= 29.00) return 6.50;
        if (price >= 12.50) return 6.25;
        return price * 0.50; // Micro prices < 12.50
    }

    // --- TAB 1 LOGIC: REVERSE PRICING ---
    function calculateReverse() {
        const i = getCommonInputs();
        if(!i.cost) { alert("Informe o custo do produto."); return; }

        const targetMargin = (parseFloat(document.getElementById('desiredMargin').value) || 0) / 100;
        const opFixed = i.opType === 'fixed' ? i.opVal : 0;
        const opPct = i.opType === 'pct' ? (i.opVal / 100) : 0;

        // Tiers for Iteration (Desc order)
        const TIERS = [
            { min: 200.00, max: 999999, idx: 4, type: 'ship' },
            { min: 150.00, max: 199.99, idx: 3, type: 'ship' },
            { min: 120.00, max: 149.99, idx: 2, type: 'ship' },
            { min: 100.00, max: 119.99, idx: 1, type: 'ship' },
            { min: 79.00,  max: 99.99,  idx: 0, type: 'ship' },
            { min: 50.00,  max: 78.99,  val: 6.75, type: 'fee' },
            { min: 29.00,  max: 49.99,  val: 6.50, type: 'fee' },
            { min: 12.50,  max: 28.99,  val: 6.25, type: 'fee' },
            { min: 0.00,   max: 12.49,  val: 0.50, type: 'micro' } // 50%
        ];

        let bestPrice = null;
        
        // Base Shipping for selected weight
        const baseRow = BASE_SHIPPING_TABLE.find(r => r.max >= i.weight) || BASE_SHIPPING_TABLE[BASE_SHIPPING_TABLE.length-1];

        for (const tier of TIERS) {
            let shipCost = 0;
            let fixedFee = 0;
            let extraVarRate = 0;

            if (tier.type === 'ship') {
                const multiplier = DISCOUNT_MATRIX[i.reputation][tier.idx];
                shipCost = baseRow.cost * multiplier;
            } else if (tier.type === 'fee') {
                fixedFee = tier.val;
            } else if (tier.type === 'micro') {
                extraVarRate = 0.50; 
            }

            // Formula: P = (FixedCosts) / (1 - VariableRates)
            const numerator = i.cost + opFixed + shipCost + fixedFee;
            const denominator = 1.0 - (i.taxPct + i.commissionPct + targetMargin + opPct + extraVarRate);

            if (denominator > 0) {
                const p = numerator / denominator;
                if (p >= tier.min && p <= tier.max) {
                    bestPrice = p;
                    break; 
                }
            }
        }

        if (bestPrice) {
            renderResults(bestPrice, i, "price");
        } else {
            alert("N√£o foi poss√≠vel calcular um pre√ßo vi√°vel com essa margem. Tente reduzir a margem ou os custos.");
        }
    }

    // --- TAB 2 LOGIC: PROFIT SIMULATION ---
    function calculateProfit() {
        const i = getCommonInputs();
        if(!i.cost) { alert("Informe o custo do produto."); return; }

        const price = parseFloat(document.getElementById('desiredPrice').value);
        if(!price) { alert("Informe o pre√ßo de venda."); return; }

        renderResults(price, i, "profit");
    }

    // --- RENDER LOGIC ---
    function renderResults(price, i, mode) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('resultContainer').style.display = 'block';

        // Calculate final details
        const shipCost = getShippingCost(price, i.weight, i.reputation);
        const fixedFee = getFixedFee(price);
        
        const opFixed = i.opType === 'fixed' ? i.opVal : 0;
        const opPctVal = i.opType === 'pct' ? (price * (i.opVal/100)) : 0;
        const totalOp = opFixed + opPctVal;

        const taxVal = price * i.taxPct;
        const commVal = price * i.commissionPct;
        
        const profit = price - i.cost - totalOp - shipCost - fixedFee - taxVal - commVal;
        const margin = (profit / price) * 100;

        // Visual Updates
        document.getElementById('dtPrice').innerText = fmt(price);
        document.getElementById('dtTotalCost').innerText = "- " + fmt(i.cost + totalOp);
        document.getElementById('dtTaxComm').innerText = "- " + fmt(taxVal + commVal);
        document.getElementById('dtShipping').innerText = "- " + fmt(shipCost);
        document.getElementById('dtFixedFee').innerText = "- " + fmt(fixedFee);
        
        const profitEl = document.getElementById('dtProfit');
        profitEl.innerText = fmt(profit);
        profitEl.className = profit >= 0 ? "text-right text-success" : "text-right text-danger";
        
        document.getElementById('dtMargin').innerText = margin.toFixed(2) + "%";

        // Main Header Update based on Mode
        if (mode === "price") {
            document.getElementById('resultLabel').innerText = "Pre√ßo Sugerido";
            document.getElementById('displayMainResult').innerText = fmt(price);
            document.getElementById('subResultInfo').innerText = `Margem: ${margin.toFixed(2)}%`;
        } else {
            document.getElementById('resultLabel').innerText = "Lucro L√≠quido";
            document.getElementById('displayMainResult').innerText = fmt(profit);
            document.getElementById('displayMainResult').style.color = profit >= 0 ? "var(--success)" : "var(--danger)";
            document.getElementById('subResultInfo').innerText = `Margem: ${margin.toFixed(2)}%`;
        }

        // Shipping Description Update
        const shipDesc = document.getElementById('shippingDesc');
        const repName = i.reputation === 'green' ? 'Verde' : (i.reputation === 'yellow' ? 'Amarela' : 'Laranja');
        
        if (shipCost > 0) {
            shipDesc.innerText = `Frete Din√¢mico (${repName})`;
        } else {
            shipDesc.innerText = "Por conta do comprador (< 79)";
        }
    }

    // --- UI HELPERS ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).classList.add('active');
        document.getElementById('tab-btn-' + (tabName === 'target-margin' ? 'margin' : 'price')).classList.add('active');
        
        document.getElementById('resultContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
    }

    function setReputation(rep) {
        document.getElementById('reputation').value = rep;
        ['green', 'yellow', 'orange'].forEach(r => document.getElementById('btn-' + r).classList.remove('active'));
        document.getElementById('btn-' + rep).classList.add('active');
    }

    function fmt(n) { return n.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }

</script>

</body>
</html>
