<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora ML 2025 (Todas as Reputações)</title>
    <style>
        :root {
            --primary: #ffe600;
            --secondary: #2d3277;
            --text: #333;
            --light-gray: #f5f5f5;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: var(--light-gray);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: var(--secondary); margin: 0; }
        
        .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 25px; }
        
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        h2 { margin-top: 0; font-size: 1.4em; color: var(--secondary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block;}

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: var(--secondary); }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .input-group { display: flex; gap: 0; }
        .input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; flex: 2; }
        .input-group select { border-top-left-radius: 0; border-bottom-left-radius: 0; flex: 1; background: #f9f9f9; border-left: 0; min-width: 100px;}

        .hint {
            display: block; font-size: 0.8em; color: #666; margin-top: 5px;
            background: #e9ecef; padding: 5px 10px; border-radius: 4px;
        }

        .btn {
            background: var(--secondary); color: #fff; border: none; padding: 15px; width: 100%;
            border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { background: #1a1e4d; }

        .result-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; text-align: center; }
        .final-price { font-size: 2.8em; font-weight: 800; color: var(--secondary); margin: 10px 0; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; color: #fff; background: #6c757d; }
        .badge.micro { background: #17a2b8; }
        .badge.green { background: #28a745; }
        .badge.yellow { background: #ffc107; color: #333; }
        .badge.orange { background: #fd7e14; }
        .badge.red { background: #dc3545; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 20px; }
        td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        .text-right { text-align: right; }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); font-weight: bold; }
        
        .reputation-selector {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .rep-option {
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; 
            text-align: center; cursor: pointer; font-weight: bold; opacity: 0.6;
        }
        .rep-option.active { opacity: 1; border: 2px solid #333; transform: scale(1.02); }
        .rep-green { background-color: #d4edda; color: #155724; }
        .rep-yellow { background-color: #fff3cd; color: #856404; }
        .rep-orange { background-color: #ffe8cc; color: #fd7e14; }

        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Calculadora ML 2025 (Multi-Reputação)</h1>
        <p>Calcula automaticamente os descontos de frete baseados na sua cor.</p>
    </div>

    <div class="grid">
        <div class="card">
            <h2>1. Sua Reputação</h2>
            <div class="reputation-selector">
                <div class="rep-option rep-green active" onclick="setReputation('green')" id="btn-green">
                    Verde / Líder / Sem Rep
                </div>
                <div class="rep-option rep-yellow" onclick="setReputation('yellow')" id="btn-yellow">
                    Amarela
                </div>
                <div class="rep-option rep-orange" onclick="setReputation('orange')" id="btn-orange">
                    Laranja / Vermelha
                </div>
            </div>
            <input type="hidden" id="reputation" value="green">

            <h2>2. Custos do Produto</h2>
            <div class="form-group">
                <label>Custo do Produto (CMV) *</label>
                <input type="number" id="productCost" placeholder="R$ 0,00" step="0.01">
            </div>

            <div class="form-group">
                <label>Peso do Produto (Tabela Oficial 2025)</label>
                <select id="productWeight">
                    <option value="0.3">Até 300g</option>
                    <option value="0.5">300g a 500g</option>
                    <option value="1.0">500g a 1kg</option>
                    <option value="2.0">1kg a 2kg</option>
                    <option value="3.0">2kg a 3kg</option>
                    <option value="4.0">3kg a 4kg</option>
                    <option value="5.0">4kg a 5kg</option>
                    <option value="9.0">5kg a 9kg</option>
                    <option value="13.0">9kg a 13kg</option>
                    <option value="17.0">13kg a 17kg</option>
                </select>
                <small class="hint">Usado para calcular o frete dinâmico.</small>
            </div>

            <div class="form-group">
                <label>Despesas Operacionais</label>
                <div class="input-group">
                    <input type="number" id="opExpenses" placeholder="3,00" step="0.01">
                    <select id="opExpensesType">
                        <option value="fixed">R$ (Fixo)</option>
                        <option value="pct">% (Venda)</option>
                    </select>
                </div>
            </div>

            <h2>3. Configurações</h2>
            <div class="form-group">
                <label>Margem de Lucro Desejada (%)</label>
                <input type="number" id="targetMargin" placeholder="Ex: 15" step="0.1">
            </div>

            <div class="form-group">
                <label>Tipo de Anúncio</label>
                <select id="listingType">
                    <option value="classic">Clássico (11.5%)</option>
                    <option value="premium">Premium (16.5%)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Impostos (%)</label>
                <input type="number" id="taxRate" placeholder="Ex: 4.0" step="0.1">
            </div>

            <button class="btn" onclick="calculatePrice()">Calcular Preço Ideal</button>
        </div>

        <div class="card">
            <h2>4. Resultado</h2>
            
            <div id="emptyState" style="text-align:center; color:#999; padding: 40px;">
                <p>O frete será ajustado conforme a reputação selecionada.</p>
            </div>

            <div id="resultContainer" style="display:none;">
                <div class="result-box">
                    <span>Preço Sugerido</span>
                    <div class="final-price" id="displayPrice">R$ 0,00</div>
                    <div id="tierBadge"></div>
                </div>

                <table>
                    <tbody>
                        <tr>
                            <td>(+) Venda Bruta</td>
                            <td class="text-right" id="dtPrice">R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>(-) Custos (Produto + Ops)</td>
                            <td class="text-right text-danger" id="dtTotalCost">- R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>(-) Impostos + Comissão</td>
                            <td class="text-right text-danger" id="dtTaxComm">- R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>
                                (-) Frete (Seller)
                                <small style="display:block; color:#777;" id="shippingDesc">Isento (< 79)</small>
                            </td>
                            <td class="text-right text-danger" id="dtShipping">- R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>(-) Taxa Fixa ML</td>
                            <td class="text-right text-danger" id="dtFixedFee">- R$ 0,00</td>
                        </tr>
                        <tr style="background-color: #f0f8ff; font-weight: bold;">
                            <td style="color:var(--success);">(=) Lucro Líquido</td>
                            <td class="text-right text-success" id="dtProfit">R$ 0,00</td>
                        </tr>
                        <tr>
                            <td>Margem Real</td>
                            <td class="text-right" id="dtMargin">0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. BASE DATA: Full Price Table (Tabela Cheia - Orange/Red) ---
    // Source: https://www.mercadolivre.com.br/ajuda/40547
    const BASE_SHIPPING_TABLE = [
        { max: 0.3, cost: 39.90 },
        { max: 0.5, cost: 42.90 },
        { max: 1.0, cost: 44.90 },
        { max: 2.0, cost: 46.90 },
        { max: 3.0, cost: 49.90 },
        { max: 4.0, cost: 53.90 },
        { max: 5.0, cost: 56.90 },
        { max: 9.0, cost: 88.90 },
        { max: 13.0, cost: 131.90 },
        { max: 17.0, cost: 146.90 }
    ];

    // --- 2. DISCOUNT RULES: (Pays %) based on Price Tier & Reputation ---
    // Green: Pays 30% to 50% of Full Price
    // Yellow: Pays 40% to 60% of Full Price
    // Orange: Pays 100% of Full Price
    const DISCOUNT_MATRIX = {
        'green':  [0.30, 0.35, 0.40, 0.45, 0.50], // 79, 100, 120, 150, 200
        'yellow': [0.40, 0.45, 0.50, 0.55, 0.60],
        'orange': [1.00, 1.00, 1.00, 1.00, 1.00]
    };

    // --- 3. LOGIC: Tiers Definition ---
    const TIERS = [
        // High Value Tiers (Dynamic Shipping)
        { min: 200.00, max: 999999, type: 'shipping', matrixIdx: 4, name: "> 200" },
        { min: 150.00, max: 199.99, type: 'shipping', matrixIdx: 3, name: "150-199" },
        { min: 120.00, max: 149.99, type: 'shipping', matrixIdx: 2, name: "120-149" },
        { min: 100.00, max: 119.99, type: 'shipping', matrixIdx: 1, name: "100-119" },
        { min: 79.00,  max: 99.99,  type: 'shipping', matrixIdx: 0, name: "79-99" },

        // Low Value Tiers (Fixed Fee)
        { min: 50.00,  max: 78.99,  type: 'fixed', val: 6.75, name: "< 79 (Taxa 6.75)" },
        { min: 29.00,  max: 49.99,  type: 'fixed', val: 6.50, name: "< 50 (Taxa 6.50)" },
        { min: 12.50,  max: 28.99,  type: 'fixed', val: 6.25, name: "< 29 (Taxa 6.25)" },
        { min: 0.00,   max: 12.49,  type: 'pct',   val: 0.50, name: "Micro (< 12.50)" }
    ];

    const LISTING_RATES = { 'classic': 0.115, 'premium': 0.165 };

    // --- UI Logic ---
    function setReputation(rep) {
        document.getElementById('reputation').value = rep;
        
        // Update Classes
        ['green', 'yellow', 'orange'].forEach(r => {
            document.getElementById('btn-' + r).classList.remove('active');
        });
        document.getElementById('btn-' + rep).classList.add('active');
        
        // Trigger recalc if data exists
        if(document.getElementById('productCost').value) calculatePrice();
    }

    function calculatePrice() {
        const cost = parseFloat(document.getElementById('productCost').value);
        if (isNaN(cost)) { alert("Insira o Custo do Produto."); return; }
        
        const weight = parseFloat(document.getElementById('productWeight').value);
        const reputation = document.getElementById('reputation').value;
        const marginPct = (parseFloat(document.getElementById('targetMargin').value) || 0) / 100;
        const taxPct = (parseFloat(document.getElementById('taxRate').value) || 0) / 100;
        const commissionPct = LISTING_RATES[document.getElementById('listingType').value];
        
        const opVal = parseFloat(document.getElementById('opExpenses').value) || 0;
        const opType = document.getElementById('opExpensesType').value;
        const opFixed = opType === 'fixed' ? opVal : 0;
        const opPct = opType === 'pct' ? opVal / 100 : 0;

        const inputs = { cost, opFixed, opPct, marginPct, taxPct, commissionPct };

        // 1. Get Base Shipping Cost for this weight
        const baseRow = BASE_SHIPPING_TABLE.find(r => r.max >= weight) || BASE_SHIPPING_TABLE[BASE_SHIPPING_TABLE.length-1];
        const baseShipCost = baseRow.cost;

        let bestPrice = null;
        let selectedTier = null;
        let finalShipCost = 0;

        // 2. Iterate Tiers
        for (const tier of TIERS) {
            let fixedFee = 0;
            let currentShipCost = 0;
            let extraVarRate = 0;

            if (tier.type === 'shipping') {
                // Calculate Dynamic Shipping: Base Cost * Discount Multiplier
                const multiplier = DISCOUNT_MATRIX[reputation][tier.matrixIdx];
                currentShipCost = baseShipCost * multiplier;
            } else if (tier.type === 'fixed') {
                fixedFee = tier.val;
            } else if (tier.type === 'pct') {
                extraVarRate = tier.val;
            }

            // P = (Cost + OpFix + Ship + FixFee) / (1 - (Tax + Comm + Margin + OpPct + ExtraVar))
            const numerator = inputs.cost + inputs.opFixed + currentShipCost + fixedFee;
            const denominator = 1.0 - (inputs.taxPct + inputs.commissionPct + inputs.marginPct + inputs.opPct + extraVarRate);
            
            if (denominator > 0) {
                const calculatedPrice = numerator / denominator;
                
                if (calculatedPrice >= tier.min && calculatedPrice <= tier.max) {
                    bestPrice = calculatedPrice;
                    selectedTier = tier;
                    finalShipCost = currentShipCost;
                    break;
                }
            }
        }

        render(bestPrice, selectedTier, finalShipCost, inputs, reputation);
    }

    function render(price, tier, shipCost, inputs, rep) {
        if (!price) {
            alert("Não foi possível encontrar uma faixa de preço válida. Verifique seus custos.");
            return;
        }

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('resultContainer').style.display = 'block';

        const feeVal = tier.type === 'pct' ? price * 0.50 : (tier.type === 'fixed' ? tier.val : 0);
        const opVal = inputs.opFixed > 0 ? inputs.opFixed : (price * inputs.opPct);
        const taxVal = price * inputs.taxPct;
        const commVal = price * inputs.commissionPct;
        
        const profit = price - inputs.cost - opVal - shipCost - feeVal - taxVal - commVal;
        const margin = (profit / price) * 100;

        document.getElementById('displayPrice').innerText = fmt(price);
        
        let badgeColor = rep === 'green' ? 'badge green' : (rep === 'yellow' ? 'badge yellow' : 'badge orange');
        let repName = rep === 'green' ? 'Verde/Líder' : (rep === 'yellow' ? 'Amarela' : 'Laranja/Vermelha');
        
        document.getElementById('tierBadge').innerHTML = `
            <span class="${badgeColor}">${repName}</span>
            <span class="badge" style="background:#6c757d; margin-left:5px;">${tier.name}</span>
        `;

        document.getElementById('dtPrice').innerText = fmt(price);
        document.getElementById('dtTotalCost').innerText = "- " + fmt(inputs.cost + opVal);
        document.getElementById('dtTaxComm').innerText = "- " + fmt(taxVal + commVal);
        
        document.getElementById('dtShipping').innerText = "- " + fmt(shipCost);
        document.getElementById('shippingDesc').innerText = shipCost > 0 
            ? `Frete Dinâmico (${repName})` 
            : "Por conta do comprador";

        document.getElementById('dtFixedFee').innerText = "- " + fmt(feeVal);
        document.getElementById('dtProfit').innerText = fmt(profit);
        document.getElementById('dtMargin').innerText = margin.toFixed(2) + "%";
    }

    function fmt(n) { return n.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }
</script>

</body>
</html>
